const e=require("fs"),t=require("path"),r=require("crypto"),n=require("obj-memory-cache"),l=require("safe-regex"),s=require("math-expression-evaluator"),i=n.newCache();let a={},o="",c="";const p=["meta","link","img","br","hr","input"],u={};function g(e){if("string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e)return;let t,r,n,l={hasContent:!1,returnResult:!1};if("function"==typeof arguments[3]?(t=arguments[1],r=arguments[2],n=arguments[3]):"function"==typeof arguments[2]?("object"!=typeof arguments[1]||Array.isArray(arguments[1])?t=arguments[1]:r=arguments[1],n=arguments[2]):"function"==typeof arguments[1]&&(n=arguments[1]),r=r?{...l,...r}:l,t?Array.isArray(t)||(t=[t]):t=[],e=e.toString().trim(),"function"==typeof t)if(n){let e=n;n=t,t=e}else n=t;return Array.isArray(t)||(t=[t]),t=t.map(e=>e.toString().trim()),u[e]={attrs:t,callback:n,opts:r},!0}g("echo",["str","allow_html"],(function(e,t,r,n){"string"==typeof t.str&&(t.str=t.str.replace(/&#44;/gs,",").replace(/&#40;/gs,"(").replace(/&#41;/gs,")"));let l=S(t.str,e,!0),s=S(t.allow_html,e);return l=["string","number","boolean"].includes(typeof l)?l.toString():"",s?l:T(l)})),g("echo_html",["str"],(function(e,t,r,n){"string"==typeof t.str&&(t.str=t.str.replace(/&#44;/gs,",").replace(/&#40;/gs,"(").replace(/&#41;/gs,")"));let l=S(t.str,e,!0);return l=["string","number","boolean"].includes(typeof l)?l.toString():"",l})),g("if",["logic"],{hasContent:!0},(function(e,t,r,n){return!(!t.logic||!r)&&!!function t(r){r.startsWith("(")&&r.endsWith(")")&&(r=r.substring(1,r.length-1)),r=r.replace(/^\((.*?)\)$/,"$1").split(/([&|])/g);let n=!1,l=!1;function s(r){let n,l=!1,s=1e3;for(;r.startsWith("!")&&s-- >0;)l=!l,r=r.replace("!","").trim();return n=r.startsWith("(")&&r.endsWith(")")?t(r):function(e,t){function r(e){return e[0]=S(e[0],t),e[1]=S(e[1],t),"string"==typeof e[0]?e[0].match(/^-?[0-9]+(\.[0-9]+|)$/)?e[0]=Number(e[0]):"true"===e[0]?e[0]=!0:"false"===e[0]&&(e[0]=!1):Array.isArray(e[0])?e[0]=e[0].length>0:"object"==typeof e[0]&&(e[0]=Object.keys(e[0]).length>0),"string"==typeof e[1]?e[1].match(/^-?[0-9]+(\.[0-9]+|)$/)?e[1]=Number(e[1]):"true"===e[1]?e[1]=!0:"false"===e[1]&&(e[1]=!1):Array.isArray(e[1])?e[1]=e[1].length>0:"object"==typeof e[1]&&(e[1]=Object.keys(e[1]).length>0),e}if(e.includes("==="))return(e=r(e.split("===",2)))[0]===e[1];if(e.includes("!=="))return(e=r(e.split("!==",2)))[0]!==e[1];if(e.includes("=="))return(e=r(e.split("==",2)))[0]===e[1];if(e.includes("!="))return(e=r(e.split("!=",2)))[0]!==e[1];if(e.includes(">="))return(e=r(e.split(">=",2)))[0]>=e[1];if(e.includes("<="))return(e=r(e.split("<=",2)))[0]<=e[1];if(e.includes("="))return(e=r(e.split("=",2)))[0]===e[1];if(e.includes(">"))return(e=r(e.split(">",2)))[0]>e[1];if(e.includes("<"))return(e=r(e.split("<",2)))[0]<e[1];if("string"==typeof(e=S(e,t)))e.match(/^-?[0-9]+(\.[0-9]+|)$/)?e=Number(e):"true"===e?e=!0:"false"===e&&(e=!1);else{if(Array.isArray(e))return e.length>0;if("object"==typeof e)return Object.keys(e).length>0}return e||0===e}(r,e),l?!n:n}for(let e=0;e<r.length;e++)if(r[e]=r[e].trim(),r[e]&&""!==r[e])if("&"===r[e]||"|"===r[e])l=r[e];else if(l)if(n&&"&"===l)n=s(r[e]);else{if(n||"|"!==l)break;n=s(r[e])}else n=s(r[e]);return n}(t.logic.toString())&&_("<?"+r+"?>",e)})),g("each",["obj","as","of","from"],{hasContent:!0},(function(e,t,r,n){if(!t.obj||!r)return;r=r.toString();let l=t.obj.split("&"),s="";for(let n=0;n<l.length;n++)t.from&&(e.$temp[t.from.replace("$","")]=l[n].split(".").pop()),E(S(l[n],e),(function(n,l){t.as&&(e.$temp[t.as.replace("$","")]=n),t.of&&(e.$temp[t.of.replace("$","")]=l),s+=_("<? "+r+" ?>",e)}));return t.as&&delete e.$temp[t.as.replace("$","")],t.of&&delete e.$temp[t.of.replace("$","")],t.from&&delete e.$temp[t.from.replace("$","")],s})),g("import",["path"],(function(r,n,l,s){if(!n.path)return;let i=n.path.toString().trim();if(i.endsWith(c)||(i+=c),i=i.startsWith(o)?t.resolve(i):t.join(o,i),!i.startsWith(o))return;let a=h(i);if(!a&&e.existsSync(i)){if(a=e.readFileSync(i).toString(),!a||""===a.trim())return void $(i,!1,r);$(i,a,r)}return a&&""!==a.trim()?(a.startsWith("\n")||(a="\n\r"+a),a.endsWith("\n")||(a+="\n\r"),a=w(a),_(a,r)):void 0})),g("setUserVar",["name","value"],(function(e,t,r,n){t.name&&t.value&&(e.$userVars[S(t.name,e,!0)]=S(t.value,e,!0))})),g("typeof",["var","literal"],{returnResult:!0,noEcho:!0},(function(e,t,r,n){let l,s=S(t.var,e);if(t.literal)return typeof s;if("string"==typeof s)try{s=JSON.parse(s)}catch(e){}return l="string"==typeof s?"[object Object]"===s?"object":"[array Array]"===s?"array":"[function Function]"===s?"function":s.match(/^[0-9]+(\.[0-9]+|)$/)?"number":"true"===s||"false"===s?"boolean":"undefined"===s?"undefined":"null"===s?"null":"string":Array.isArray(s)?"array":typeof s,"'"+l+"'"})),g("log",(function(e,t,r,n){if(!t)return;let l=[];E(t,t=>{let r=S(t,e);l.push([t,r])}),console.log(...l)}));const f={runMainFunctions:_,escapeHtml:T,unescapeHtml:O,escapeRegex:M,escapeInvalidTags:k,stripInvalidTags:R,forEach:E,autoCloseTags:w,getFileCache:h,setFileCache:$};function m(e){return r.randomBytes(e).toString("hex")}function h(e){return i.get("template_file:"+e)}function $(e,t,r){t&&(t=t.toString()),i.set("template_file:"+e,t,{expire:r.cache||a.cache})}function y(r,n,l){c=r.substr(r.lastIndexOf(".")),o=t.join(r,"..");let s=h(r);if(s){if(a&&"function"==typeof a.onBeforeRender){let e=a.onBeforeRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}else if(n&&"function"==typeof n.onBeforeRender){let e=n.onBeforeRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}let e=d(s,n);if(a&&"function"==typeof a.onAfterRender){let t=a.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}else if(n&&"function"==typeof n.onAfterRender){let t=n.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}return l(null,e.toString())}e.readFile(r,(function(e,t){if(e)return l(e);if($(r,t,n),a&&"function"==typeof a.onBeforeRender){let e=a.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}else if(n&&"function"==typeof n.onBeforeRender){let e=n.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}let s=d(t,n);if(a&&"function"==typeof a.onAfterRender){let e=a.onAfterRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}else if(n&&"function"==typeof n.onAfterRender){let e=n.onAfterRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}return l(null,s.toString())}))}function d(r,n={}){let s=!1;if(a.logSpeed&&(s=(new Date).getTime()),r=r.toString(),a&&a.raw)return r;if(r.startsWith("\n")||(r="\n\r"+r),r.endsWith("\n")||(r+="\n\r"),r=w(r),n){let e={};E(n,(t,r)=>{"function"!=typeof t&&(["string","number","boolean","object"].includes(typeof t)||Array.isArray(t))&&(e[r]=t)}),n=e}else n={};n.opts&&"object"==typeof n.opts||(n.opts={}),n.$&&"object"==typeof n.$||(n.$={}),n.$functions&&"object"==typeof n.$functions||(n.$functions={}),n.$temp&&"object"==typeof n.$temp||(n.$temp={}),n.$userVars&&"object"==typeof n.$userVars||(n.$userVars={}),n.$returns&&"object"==typeof n.$returns||(n.$returns={}),n.$strings&&"object"==typeof n.$strings||(n.$strings={}),n.extractTags?Array.isArray(n.extractTags)||(n.extractTags=[n.extractTags]):n.extractTags=[],a.extractTags&&(Array.isArray(a.extractTags)||(a.extractTags=[a.extractTags]),n.extractTags=[...a.extractTags,...n.extractTags]),r=(r=function(r,n){if(n.template||a.template){let l=n.template||a.template;if(l.endsWith(c)||(l+=c),l=l.startsWith(o)?t.resolve(l):t.join(o,l),!l.startsWith(o))return r;let s=h(l);if(!s&&e.existsSync(l)){if(s=e.readFileSync(l).toString(),!s||""===s.trim())return $(l,!1,n),r;$(l,s,n)}if(!s||""===s.trim())return r;s.startsWith("\n")||(s="\n\r"+s),s.endsWith("\n")||(s+="\n\r"),s=w(s),r=s.replace(/(<\?(js|php|)\s*?body\(\);?\s*?\?>|{{{?#?\s*?body\s*?}}}?)/gs,r)}return r}(r,n)).split(/({{{?#no[_-]?html}}}?.*?{{{?\/no[_-]?html}}}?)/gis);for(let e=0;e<r.length;e++)r[e].match(/({{{?#no[_-]?html}}}?.*?{{{?\/no[_-]?html}}}?)/gis)?r[e]=T(r[e].replace(/{{{?#no[_-]?html}}}?(.*?){{{?\/no[_-]?html}}}?/gis,"$1")):r[e]=b(r[e],n);r=(r=function(e,t){if(t.extractTags&&t.extractTags.length&&Array.isArray(t.extractTags)){let r=t.extractTags.map(e=>M(e.toString())).join("|");t.extractTags.includes("style")&&!t.extractTags.includes("link")&&(r+="|link");let n=new RegExp("<("+r+")(\\s+?.*?|)>(.*?)<\\/(?:"+r+")(?:\\s+?.*?|)>","gs");if(l(n)){const r={};e=e.replace(n,(function(e,n,l,s){let i="<"+(n=n.trim())+" "+l.trim()+">"+s+"</"+n+">";return"link"===n&&t.extractTags.includes("style")&&l.match(/\s+?rel="stylesheet"/gs)?(r.style||(r.style=[]),r.style.push(i),""):"link"!==n||t.extractTags.includes("link")&&!l.match(/\s+?rel="stylesheet"/gs)?(r[n]||(r[n]=[]),r[n].push(i),""):i})),n=new RegExp("{{-("+n+")}}","gs"),l(n)&&(e=e.replace(n,(function(e,t){return r[t]?r[t].join("\n"):""})))}}return e}(r=function(e,t){return e.replace(/({{{?)(.*?)(}}}?)/gs,(function(e,r,n,l){if(!n||""===n.trim())return"";const s="{{{"!==r||"}}}"!==l;if((n=n.toString().trim()).startsWith("-"))return n=n.substring(1).trim(),t.extractTags.push(n),"{{-"+n+"}}";if(n.includes("=")){if(!(n=n.split("=",2))[1]||""===n[1].trim())return"";n[1]=n[1].trim(),n[1].startsWith('"')&&n[1].endsWith('"')&&(n[1]=n[1].substring(1,n[1].length-1)),n[0]&&""!==n[0].trim()?n[0]=n[0].trim():n[0]=n[1],n[0].includes(".")&&(n[0]=n[0].split(".",1)[0]),n[0].includes("[")&&(n[0]=n[0].split("[",1)[0]);let e=S(n[1],t,"regve");return s&&(e=T(e)),n[0]+'="'+e+'"'}{n.startsWith('"')&&n.endsWith('"')&&(n=n.substring(1,n[1].length-1));let e=S(n,t,"regve");return s&&(e=T(e)),e}}))}(r=(r=(r=_(r=r.join(""),n)).replace(/<\?(js|php|).*?\?>/gs,"")).replace(/<&[\w_\-]*%.*?%&>/gs,""),n),n)).split(/({{{?#no[_-]?html}}}?.*?{{{?\/no[_-]?html}}}?)/gis);for(let e=0;e<r.length;e++)r[e].match(/({{{?#no[_-]?html}}}?.*?{{{?\/no[_-]?html}}}?)/gis)?r[e]=T(r[e].replace(/{{{?#no[_-]?html}}}?(.*?){{{?\/no[_-]?html}}}?/gis,"$1")):r[e]=b(r[e],n);if(r=r.join(""),!a.noMarkdown&&!n.noMarkdown){r=r.split(/({{{?#no[_-]?markdown}}}?.*?{{{?\/no[_-]?markdown}}}?)/gis);for(let e=0;e<r.length;e++)r[e].match(/({{{?#no[_-]?markdown}}}?.*?{{{?\/no[_-]?markdown}}}?)/gis)?r[e]=r[e].replace(/{{{?#no[_-]?markdown}}}?(.*?){{{?\/no[_-]?markdown}}}?/gis,"$1"):r[e]=v(r[e],n);r=r.join("")}if(r=(r=(r=(r=r.replace(/<\?(js|php|).*?\?>/gs,"").replace(/\?>/gs,"")).replace(/<&[\w_\-]*%.*?%&>/gs,"")).replace(/{{{?.*?}}}?/gs,"")).toString().trim(),a.logSpeed&&s){let e=(new Date).getTime()-s;console.log("[34mAspive rendered in[32m",e,"[34mmilliseconds[0m")}return r}function b(e,t){return e=e.replace(/\$\{(.*?)\}/gm,(function(e,r){return r=r.trim(),t.$userVars[r]?t.$userVars[r]:""})),t.noHtmlRules&&t.noHtmlRules.allowUserVars&&(e=e.replace(/\$&lbrace;(.*?)&rbrace;/gm,(function(e,r){return r=r.trim(),t.$userVars[r]?t.$userVars[r]:""}))),e}function _(e,t){return e.replace(/<\?(js|php|)(.*?)\?>/gs,(function(e,r,n){let s="";function i(e){return["string","number","boolean"].includes(typeof e)?e.toString():""}n=n.replace(/\/\*.*?\*\//gs,"").replace(/\/\/.*/gm,"");const a={...f};function o(e){s+=e.toString()}a.result=function(e){s+=i(e)},a.setResult=i,n=(n=n.replace(/\\'/gs,"&#39;").replace(/\\"/gs,"&#34;").replace(/(['"])(.*?)\1/gs,(function(e,r,n){let l=m(16)+m(16);return t.$strings[l]=r+n.replace(/&#39;/gs,"\\'").replace(/&#34;/gs,'\\"')+r,"<&string%"+l+"%&>"}))).replace(/[\n\r\t\s]/gs," ").replace(/\s\s/gs," ").replace(/else\s*?{/gs,"else if(true){");const c={};let p=1e3;for(;n.match(/\{([^{}]*)\}/gs)&&p-- >0;)n=n.replace(/\{([^{}]*)\}/gs,(function(e,t){let r=m(16)+m(16);return c[r]=t,"<&%"+r+"%&>"}));n=(n=(n=n.replace(/<&%(.*?)%&>/gs,(function(e,t){return"{<&%"+t+"%&>}"}))).replace(/function\s*?([\w_\-.\[\]]+)\((.*?)\)\s*?\{<&%(.*?)%&>\}/gs,(function(e,r,n,l){l=c[l]?c[l]:"",n=n.split(",").map(e=>e.trim()).filter(e=>e&&""!==e);let s=1e3;for(;l.match(/<&%(.*?)%&>/gs)&&s-- >0;)l=l.replace(/<&%(.*?)%&>/gs,(function(e,t){return c[t]?"{"+c[t]+"}":"{}"}));return t.$functions[r]=function(e,t){const r=l,s=n,i={};for(let r=0;r<t.length;r++){let n=s[r]||r;i[n]=S(t[r],e)}let a=_("<? "+r.replace(/\$([\w_\-.\[\]]+)/gs,(function(t,r){return r="$"+r.toString().trim(),i[r]?S(i[r],e):t}))+" ?>",e),o=!1;return a=a.replace(/<&return%(.*?)%&>.*?/gs,(function(t,r){return o||(o=e.$returns[r]),""})),{result:a,return:o}},""}))).split(/(.*?[;}])/gs).filter(e=>e&&""!==e.trim()).map(e=>{e=e.replace(/\{<&%(.*?)%&>\}/gs,(function(e,t){return t&&""!==t.trim()&&c[t]?"{"+c[t]+"}":"{}"}));let t=0;for(;e.match(/<&%(.*?)%&>/gs)&&t-- >0;)e=e.replace(/<&%(.*?)%&>/gs,(function(e,t){return t&&""!==t.trim()&&c[t]?"{"+c[t]+"}":"{}"}));return e});const u={runElse:!1};for(let e=0;e<n.length;e++){if(n[e]=n[e].trim(),n[e].startsWith("return ")){let r=m(16)+m(16);t.$returns[r]=n[e].replace("return ","").replace(/;$/,""),s+="<&return%"+r+"%&>";break}if(n[e].startsWith("echo_html ")?n[e]="echo("+n[e].replace(/^echo_html\s*/,"").replace(/;$/,"").replace(/,/gs,"&#44;").replace(/\(/gs,"&#40;").replace(/\)/gs,"&#41;")+", true);":n[e].startsWith("echo ")&&(n[e]="echo("+n[e].replace(/^echo\s*/,"").replace(/;$/,"").replace(/,/gs,"&#44;").replace(/\(/gs,"&#40;").replace(/\)/gs,"&#41;")+");"),n[e].match(/^\$[\w_\-.\[\]]+\s*?[+\-*\/.]?=\s*?.*?/))n[e].replace(/^\$([\w_\-.\[\]]+)\s*?([+\-*\/.]|)=\s*?(.*?)[;}]/,(function(e,r,n,s){if(s=S(s,t,!1,{funcOpts:u,funcMethods:a},o),!n||""===n.trim())return void(t.$[r]=s);let i=t.$[r];if("string"==typeof i&&i.match(/^-?[0-9]+(\.[0-9]+|)$/)&&Number(i)&&(i=Number(i)),Array.isArray(i))"+"===n||"."===n||"*"===n?t.$[r].push(s):"-"!==n&&"/"!==n||i.indexOf(s)&&t.$[r].splice(i.indexOf(s),1);else if("object"!=typeof i||"object"!=typeof s)if("object"!=typeof i||"string"!=typeof s&&!Array.isArray(s)||"-"!==n&&"/"!==n){if(["string","boolean","number"].includes(typeof s)&&["string","boolean","number"].includes(typeof i))if("+"===n||"."===n)t.$[r]=i+s;else if("-"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i-s;else if("-"===n)t.$[r]=i.replace(s,"");else if("*"===n&&"number"==typeof s&&"string"==typeof i)t.$[r]=i.repeat(s);else if("*"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i*s;else if("*"===n)t.$[r]=i+s;else if("/"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i/s;else if("/"===n){let e=new RegExp(M(s),"g");l(e)&&(t.$[r]=i.replace(e,""))}}else{let e=Object.keys(i),t=Object.values(i);Array.isArray(s)||(s=[s]);for(let r=0;r<s.length;r++)delete i[e[t.indexOf(s[r])]]}else if("+"===n||"."===n||"*"===n){let e=Object.keys(s);for(let t=0;t<e.length;t++)i[e[t]]=s[e[t]];t.$[r]=i}else if("-"===n||"/"===n){let e=Object.keys(i),t=Object.values(i),r=Object.values(s);for(let n=0;n<r.length;n++)delete i[e[t.indexOf(r[n])]]}}));else if(n[e].match(/^(else |)[\w_\-.\[\]]+\(.*?\)(\{.*?\}|)/)){let r=j(n[e],t,u.runElse,a);u.runElse=r.runElse,r.result&&(s+=r.result.toString())}}return s}))}function j(e,t,r=!1,n){let l="",s=!1;return e.replace(/^(else |)([\w_\-.\[\]]+)\((.*?)\)(?:\{(.*?)\}|)/,(function(e,i,a,o,c){if(r||!i||""===i.trim())if(r=!1,o=(o=o?o.toString():"").split(",").map(e=>(e=e.replace(/<&string%(.*?)%&>/gs,(function(e,r){return t.$strings[r]?t.$strings[r]:""}))).trim()).filter(e=>e&&""!==e),t.$functions[a]){let e=t.$functions[a](t,o);e.result&&(l+=e.result.toString()),e.return&&(s=e.return)}else if(u[a]){let e={};if(u[a].attrs){let t=u[a].attrs;for(let r=0;r<t.length;r++)e[t[r]]=o.shift()}for(let t=0;t<o.length;t++)e[t]||(e[t]=o[t]);n.setObject=function(e,r){return S(e,t,r)};let i=void 0;u[a].opts.hasContent&&c&&""!==c.toString().trim()?i=u[a].callback(t,e,c.toString(),n):u[a]&&(i=u[a].callback(t,e,null,n)),!1===i?(r=!0,s=!1):i&&(i=i.replace(/<&return%(.*?)%&>.*?/gs,(function(e,r){return s||(s=t.$returns[r]),""})),l+=i.toString()),u[a].opts.returnResult&&(s=i),u[a].opts.noEcho&&(l="")}})),{result:l,return:s,runElse:r}}function S(e,t,r=!1,n=!1,l=!1){if(!e||!["string","number","boolean"].includes(typeof e))return;(e=e.toString().trim()).endsWith(";")&&(e=e.substring(0,e.length-1)),e.match(/<&string%.*?%&>/)&&(e=e.replace(/<&string%(.*?)%&>/gs,(function(e,r){return t.$strings[r]?t.$strings[r]:""})));let s=!1;"regve"===r&&(s="regve"),e=e.split("|");let i=void 0;for(let a=0;a<e.length;a++)if(e[a].includes("&")){let r=e[a].split("&"),l=!1;for(let e=0;e<r.length&&(l=!!A(r[e],t,s,n),l);e++);if(l){i=!0;break}}else if(i=A(e[a],t,s,n),i){i=A(e[a],t,r,n,l);break}return r?(["string","number","boolean"].includes(typeof i)||(i=""),i.toString()):i}function A(e,t,r=!1,n=!1,s=!1){if(!e||!["string","number","boolean"].includes(typeof e))return;(e=e.toString().trim()).endsWith(";")&&(e=e.substring(0,e.length-1));let i=!1;if("regve"===r&&(i=!0),!i&&n&&"string"==typeof e&&e.match(/([\w_\-$]+)\((.*?)\)/)){const r={...f};r.result=function(e){c+=e},r.setResult=function(e){return["string","number","boolean"].includes(typeof e)?e.toString():""},e=e.split(/([\w_\-$]+\(.*?\))/);for(let n=0;n<e.length;n++)if(e[n].match(/^([\w_\-$]+)\((.*?)\)$/)){let l=j(e[n],t,!1,r);l.result&&s&&s(l.result),l.return&&(e[n]=l.return)}e=e.join("")}let a=!1;if(e.startsWith("{")&&!e.endsWith("}")&&(e+="}",a=!0),e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]"))try{let t=JSON.parse(q(e));return r&&(t=JSON.stringify(t),a&&(t=t.replace(/}$/,""))),t}catch(e){}a&&(e=e.replace(/}$/,""));const o={};e=(e=e.replace(/\\'/gs,"&#39;").replace(/\\"/gs,"&#34;").replace(/(['"])(.*?)\1/gs,(function(e,t,r){let n=m(16)+m(16);return o[n]=r.replace(/&#39;/gs,"'").replace(/&#34;/gs,'"'),t+"<&%"+n+"%&>"+t})).replace(/&#39;/gs,"\\'").replace(/&#34;/gs,'\\"')).split(/((?:[0-9+\-*/^().e!]|pi|sin|cos|tan|asin|acos|atan|root|pow)+)/gs);for(let t=0;t<e.length;t++)e[t]&&""!==e[t].trim()&&!e[t].match(/^[\w0-9.]+$/s)&&e[t].match(/^([0-9+\-*/^().e!]|pi|sin|cos|tan|asin|acos|atan|root|pow)+$/s)&&(e[t]=e[t].split(/^([+\-*/.]*)(.*?)([+\-*/.]*)$/s),e[t][2]&&(e[t][2]=W(e[t][2])),e[t]=e[t].join(""));(e=e.join("").split(/([+\-*\/]|\.(?=[^\w_0-9])|[^\w_0-9]\.(?=[0-9]))/g)).length>1&&(r=!0);let c="",p=".";function u(e){if(r){if("undefined"!=typeof e)if("."===p||"+"===p)c+=e.toString();else if("-"===p)c=c.replace(e.toString(),"");else if("*"!==p||"number"!=typeof e&&!e.toString().match(/^[0-9]+(\.[0-9]+|)$/)){if("*"===p)c+=e.toString();else if("/"===p){let t=new RegExp(M(e.toString()),"g");l(t)&&(c=c.replace(t,""))}}else c=c.repeat(Number(e))}else c=e}for(let t=0;t<e.length;t++)e[t].match(/^(['"])\s*?\.\s*?\1?.?$/)&&(e[t]="."),[".","+","-","*","/"].includes(e[t].trim())?p=e[t].trim():e[t].trim().match(/^[0-9]+(\.[0-9]+|)$/s)?u(e[t].trim()):(e[t].trim().match(/^(['"])<&%(.*)%&>(\1|)$/)&&(e[t]=e[t].trim().replace(/^(['"])<&%(.*)%&>(\1|)$/,(function(e,t,r){return o[r]?t+o[r]+t:t+t}))),e[t].match(/^(['"]).*\1.?$/)?u(e[t].trim().replace(/^(['"])(.*)\1.?$/,"$2")):e[t].match(/^(['"]).*.?$/)?(e[t+1]&&e[t+1].match(/^(['"])\s*?\.\s*?.?$/)&&(e[t+1].startsWith("'")?e[t]+="'":e[t+1].startsWith('"')&&(e[t]+='"')),u(e[t].trim().replace(/^(['"])(.*)\1.?$/,"$2"))):u(g(e[t].trim())));function g(e){e=e.split("|");let t=void 0;for(let r=0;r<e.length&&(t=h(e[r]),!t);r++);return i&&void 0===t&&(t=""),t}function h(e){let n;return"true"===e||"false"!==e&&(i&&e.startsWith("$")?n=B(e.replace("$",""),t.$):i?n=B(e,t.opts):e.startsWith("$Opts.")||e.startsWith("$Options.")||e.startsWith("$_OPTIONS.")||e.startsWith("$_OPTS.")?n=B(e.replace(/^\$_?opt(?:ion)?s(\.|\[(.*?|)\])/i,$),t.opts):e.startsWith("$Post.")||e.startsWith("$_POST.")?n=B("req.body."+e.replace(/^\$_?post(\.|\[(.*?|)\])/i,$),t):e.startsWith("$Get.")||e.startsWith("$_GET.")?n=B("req.query."+e.replace(/^\$_?get(\.|\[(.*?|)\])/i,$),t):e.startsWith("$Data.")||e.startsWith("$_DATA.")?n=B("req.data."+e.replace(/^\$_?data(\.|\[(.*?|)\])/i,$),t):e.startsWith("$")?(n=B(e.replace("$",""),t.$temp),n||(n=B(e.replace("$",""),t.$))):n=B(e,t.$),r&&(n=!n&&0!==n||!["string","number","boolean"].includes(typeof n)?void 0:n.toString()),n)}function $(e,t){return t?t.replace(/\s/g,"").replace(/^\.*/,""):""}return r?(["string","number","boolean"].includes(typeof c)||(c=""),c.toString()):("string"==typeof c&&c.match(/^-?[0-9]+(\.[0-9]+|)$/)?c=Number(c):"true"===c?c=!0:"false"===c?c=!1:"null"===c?c=null:"undefined"===c&&(c=void 0),c)}function W(e){e=e.toString();try{e=s.eval(e)}catch(t){e="NaN"}return e}function v(e,t){if(!e&&0!==e&&!1!==e)return null;e=e.toString();let r={};return"object"==typeof a.noHtmlRules&&"object"==typeof t.noHtmlRules?r={...a.noHtmlRules,...t}:"object"==typeof a.noHtmlRules?r={...a.noHtmlRules}:"object"==typeof t.noHtmlRules&&(r={...t.noHtmlRules}),e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/(?:\*|&ast;){3}([^*]+)(?:\*|&ast;){3}/g,"<strong><em>$1</em></strong>")).replace(/(?:\*|&ast;){2}([^*]+)(?:\*|&ast;){2}/g,"<strong>$1</strong>")).replace(/(?:\*|&ast;)([^*]+)(?:\*|&ast;)/g,"<em>$1</em>")).replace(/__([^_]+)__/g,"<u>$1</u>")).replace(/~~([^~]+)~~/gs,"<s>$1</s>")).replace(/(?:#){6}\s*(.+)/g,"<h6>$1</h6>")).replace(/(?:#){5}\s*(.+)/g,"<h5>$1</h5>")).replace(/(?:#){4}\s*(.+)/g,"<h4>$1</h4>")).replace(/(?:#){3}\s*(.+)/g,"<h3>$1</h3>")).replace(/(?:#){2}\s*(.+)/g,"<h2>$1</h2>")).replace(/(?:#)\s*(.+)/g,"<h1>$1</h1>"),r.allowHeaders&&(e=(e=(e=(e=(e=(e=e.replace(/(?:&num;){6}\s*(.+)/g,"<h6>$1</h6>")).replace(/(?:&num;){5}\s*(.+)/g,"<h5>$1</h5>")).replace(/(?:&num;){4}\s*(.+)/g,"<h4>$1</h4>")).replace(/(?:&num;){3}\s*(.+)/g,"<h3>$1</h3>")).replace(/(?:&num;){2}\s*(.+)/g,"<h2>$1</h2>")).replace(/(?:&num;)\s*(.+)/g,"<h1>$1</h1>")),e=(e=(e=(e=(e=(e=e.replace(/[\n\r]-{3,}[\n\r]/g,"<hr>")).replace(/(?:`|&grave;){3}(.+?)(?:`|&grave;){3}/gs,"<pre>$1</pre>")).replace(/(?:`|&grave;)(.+?)(?:`|&grave;)/gs,"<p>$1</p>")).replace(/([^"'])((?!["'])https?:\/\/(?:(?:[\w_-][\w_\-.]+)|)(?:(?:[\w.,@?^=%&:/~+#_-]*[\w.,@?^=%&:/~+#_-])|))/g,'$1<a href="$2">$2</a>')).replace(/\!\[(.*?)\]\((.*?)\)/g,'<img src="$2" alt="$1">')).replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),r.allowImages&&(e=e.replace(/\!&lbrack;(.*?)&rbrack;&lpar;(.*?)&rpar;/g,'<img src="$2" alt="$1">')),r.allowCustomLinks&&(e=e.replace(/&lbrack;(.*?)&rbrack;&lpar;(.*?)&rpar;/g,'<a href="$2">$1</a>')),(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\[ss\]/g,"§")).replace(/\[$c\]/g,"¢")).replace(/\[$e\]/g,"€")).replace(/\[$p\]/g,"£")).replace(/\[c\]/g,"©")).replace(/\[r\]/g,"®")).replace(/\[tm\]/g,"™")).replace(/\[p\]/g,"¶")).replace(/\[Dc\]/g,"℃")).replace(/\[Df\]/g,"℉")).replace(/\[D\]/g,"°")).replace(/\[M\+\]/g,"+")).replace(/\[M-\]/g,"−")).replace(/\[Mx\]/g,"×")).replace(/\[M\/\]/g,"÷")).replace(/\[M=\]/g,"=")).replace(/\[M\!=\]/g,"≠")).replace(/\[M\+-\]/g,"±")).replace(/\[M<\]/g,"<")).replace(/\[M>\]/g,">")).replace(/\[M<=\]/g,"⋜")).replace(/\[M>=\]/g,"⋝")).replace(/\[M%\]/g,"%")).replace(/\[M%0\]/g,"‰")).replace(/\[M%00\]/g,"‱")).replace(/\[Msum\]/g,"∑")).replace(/\[M(sqrt|2root|root)\]/g,"√")).replace(/\[M(cbrt|3root)\]/g,"∛")).replace(/\[M4root\]/g,"∜")).replace(/\[M00\]/g,"∞")).replace(/\[MA(r|90)\]/g,"∟")).replace(/\[MA(a|45|)\]/g,"∠")).replace(/\[M=\?\]/g,"≈")}function w(e){if(!e&&0!==e&&!1!==e)return null;if(e=k(e+="?>"),!p||p.length<1)return e.toString();const t=p.join("|");let r=[],n=new RegExp("(</?(?![^A-Za-z0-9_-]|!DOCTYPE|"+t+")(?:(?:\\s+?[^>]*?)|)>)","gsi");if(!l(n))return e.toString();for(e=e.split(n).map(e=>{if(e.match(n)){let t=e.replace(/<\/?([A-Za-z0-9_-]+).*?>/gis,"$1");if(e.startsWith("</")){if(r.length<=0)return"";if(r[r.length-1]===t)return r.pop(),"</"+t+">";{let e="";for(;r.length>0&&r[r.length-1]!==t;)e+="</"+r[r.length-1]+">",r.pop();return e}}r.push(t)}return e});r.length>0;)e.push("</"+r[r.length-1]+">"),r.pop();return(e=e.join("")).toString()}function x(e){return e&&"string"==typeof e&&""!==e.trim()?(p.includes(e)||p.push(e),!0):null}function k(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"&lt;$1$2$3"):null}function R(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"$2$3"):null}function T(e){return e||0===e||!1===e?e.toString().replace(/&(?!(amp|gt|lt|lbrace|rbrace|sol|bsol|quest|equals|lbrack|rbrack|lpar|rpar|vert|num|sect|ast|comma|period|grave|apos|quot);)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/{/g,"&lbrace;").replace(/}/g,"&rbrace;").replace(/\//g,"&sol;").replace(/\\/g,"&bsol;").replace(/\?/g,"&quest;").replace(/=/g,"&equals;").replace(/\[/g,"&lbrack;").replace(/\]/g,"&rbrack;").replace(/\(/g,"&lpar;").replace(/\)/g,"&rpar;").replace(/\|/g,"&vert;").replace(/#/g,"&num;").replace(/§/g,"&sect;").replace(/\*/g,"&ast;").replace(/,/g,"&comma;").replace(/\./g,"&period;").replace(/`/g,"&grave;").replace(/'/g,"&apos;").replace(/"/g,"&quot;"):null}function O(e){return e||0===e||!1===e?e.toString().replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&lbrace;/g,"{").replace(/&rbrace;/g,"}").replace(/&sol;/g,"/").replace(/&bsol;/g,"\\").replace(/&quest;/g,"?").replace(/&equals;/g,"=").replace(/&lbrack;/g,"[").replace(/&rbrack;/g,"]").replace(/&lpar;/g,"(").replace(/&rpar;/g,")").replace(/&vert;/g,"|").replace(/&num;/g,"#").replace(/&sect;/g,"§").replace(/&ast;/g,"*").replace(/&comma;/g,",").replace(/&period;/g,".").replace(/&grave;/g,"`").replace(/&apos;/g,"'").replace(/&quot;/g,'"'):null}function M(e){return e.replace(/([.*+?^${}()|[\]\\])/g,"\\$1")}function q(e){return e.replace(/[\s\n\r\t]/gs,"").replace(/,([}\]])/gs,"$1").replace(/([,{\[]|)(?:("|'|)([\w_\- ]+)\2:|)("|'|)(.*?)\4([,}\]])/gs,(e,t,r,n,l,s,i)=>(s=s.replace(/"/gis,"").trim(),n&&(n='"'+n.replace(/"/gis,"").trim()+'"'),s.match(/^[0-9]+(\.[0-9]+|)$/)||["true","false"].includes(s)||(s='"'+s+'"'),n?t+n+":"+s+i:t+s+i))}function E(e,t){if(e&&["string","number"].includes(typeof e)&&(e=[e]),e&&"object"==typeof e){let r=Object.keys(e);for(let n=0;n<r.length;n++)t(e[r[n]],r[n],e)}else if(e&&Array.isArray(e))for(let r=0;r<e.length;r++)t(e[r],r,e)}function B(e,t){return!t||!e||"object"!=typeof t&&!Array.isArray(t)||"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e?null:(e=e.split(/(?:\.|\[([^\]]+)\])/gs).filter(e=>e&&""!==e.trim())).reduce((function(e,t){if(t&&"object"==typeof e&&"undefined"!=typeof e[t])return e[t]}),t)}module.exports=function(){let e=function(e){return"object"==typeof e&&(Object.assign(a,e),(e.cacheDev||!1===e.cacheDev)&&n.cacheDevelopment(e.cacheDev)),y};return e.render=d,e.addFunction=g,e.defineSingleTagType=x,e.customMarkdown=v,e.escapeHtml=T,e.unescapeHtml=O,e.escapeInvalidTags=k,e.stripInvalidTags=R,e.escapeRegex=M,e.normalizeJson=q,e.forEach=E,e.getObj=B,e.autoCloseTags=w,e}();
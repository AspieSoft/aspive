const e=require("fs"),t=require("path"),r=require("crypto"),n=require("obj-memory-cache"),l=require("safe-regex"),s=require("math-expression-evaluator"),i=n.newCache();let a={},c="",o="";const u=["meta","link","img","br","hr","input"],p={};function f(e,t,r,n=!1){if("string"==typeof e||"number"==typeof e||"boolean"==typeof e){if(e=e.toString().trim(),"function"==typeof t)if(r){let e=r;r=t,t=e}else r=t;return n=!!n,Array.isArray(t)||(t=[t]),t=t.map(e=>e.toString().trim()),p[e]={attrs:t,callback:r,hasContent:n},!0}}f("echo",["str","allow_html"],(function(e,t,r,n){let l=j(t.str,e,!0),s=j(t.allow_html,e);return l=["string","number","boolean"].includes(typeof l)?l.toString():"",s?_(l,e):T(l)})),f("echo_html",["str","allow_html"],(function(e,t,r,n){let l=j(t.str,e,!0);return j(t.allow_html,e),l=["string","number","boolean"].includes(typeof l)?l.toString():"",_(l,e)})),f("if",["logic"],(function(e,t,r,n){return!(!t.logic||!r)&&!!function t(r){r.startsWith("(")&&r.endsWith(")")&&(r=r.substring(1,r.length-1)),r=r.replace(/^\((.*?)\)$/,"$1").split(/([&|])/g);let n=!1,l=!1;function s(r){let n,l=!1,s=1e3;for(;r.startsWith("!")&&s-- >0;)l=!l,r=r.replace("!","").trim();return n=r.startsWith("(")&&r.endsWith(")")?t(r):function(e,t){function r(e){return e[0]=j(e[0],t),e[1]=j(e[1],t),"string"==typeof e[0]?e[0].match(/^-?[0-9]+(\.[0-9]+|)$/)?e[0]=Number(e[0]):"true"===e[0]?e[0]=!0:"false"===e[0]&&(e[0]=!1):Array.isArray(e[0])?e[0]=e[0].length>0:"object"==typeof e[0]&&(e[0]=Object.keys(e[0]).length>0),"string"==typeof e[1]?e[1].match(/^-?[0-9]+(\.[0-9]+|)$/)?e[1]=Number(e[1]):"true"===e[1]?e[1]=!0:"false"===e[1]&&(e[1]=!1):Array.isArray(e[1])?e[1]=e[1].length>0:"object"==typeof e[1]&&(e[1]=Object.keys(e[1]).length>0),e}if(e.includes("==="))return(e=r(e.split("===",2)))[0]===e[1];if(e.includes("!=="))return(e=r(e.split("!==",2)))[0]!==e[1];if(e.includes("=="))return(e=r(e.split("==",2)))[0]===e[1];if(e.includes("!="))return(e=r(e.split("!=",2)))[0]!==e[1];if(e.includes(">="))return(e=r(e.split(">=",2)))[0]>=e[1];if(e.includes("<="))return(e=r(e.split("<=",2)))[0]<=e[1];if(e.includes("="))return(e=r(e.split("=",2)))[0]===e[1];if(e.includes(">"))return(e=r(e.split(">",2)))[0]>e[1];if(e.includes("<"))return(e=r(e.split("<",2)))[0]<e[1];if("string"==typeof(e=j(e,t)))e.match(/^-?[0-9]+(\.[0-9]+|)$/)?e=Number(e):"true"===e?e=!0:"false"===e&&(e=!1);else{if(Array.isArray(e))return e.length>0;if("object"==typeof e)return Object.keys(e).length>0}return e||0===e}(r,e),l?!n:n}for(let e=0;e<r.length;e++)if(r[e]=r[e].trim(),r[e]&&""!==r[e])if("&"===r[e]||"|"===r[e])l=r[e];else if(l)if(n&&"&"===l)n=s(r[e]);else{if(n||"|"!==l)break;n=s(r[e])}else n=s(r[e]);return n}(t.logic.toString())&&_("<?"+r+"?>",e)}),!0),f("each",["obj","as","of","from"],(function(e,t,r,n){}),!0),f("import",["path"],(function(r,n,l,s){if(!n.path)return;let i=n.path.toString().trim();if(i.endsWith(o)||(i+=o),i=i.startsWith(c)?t.resolve(i):t.join(c,i),!i.startsWith(c))return;let a=h(i);if(!a&&e.existsSync(i)){if(a=e.readFileSync(i).toString(),!a||""===a.trim())return void $(i,!1,r);$(i,a,r)}return a&&""!==a.trim()?(a.startsWith("\n")||(a="\n\r"+a),a.endsWith("\n")||(a+="\n\r"),a=A(a),_(a,r)):void 0})),f("setUserVar",["name","value"],(function(e,t,r,n){t.name&&t.value&&(e.$userVars[t.name.toString().trim()]=j(t.value,e))}));const g={runMainFunctions:_,escapeHtml:T,unescapeHtml:R,escapeRegex:O,escapeInvalidTags:v,stripInvalidTags:k,forEach:q,autoCloseTags:A,getFileCache:h,setFileCache:$};function m(e){return r.randomBytes(e).toString("hex")}function h(e){return i.get("template_file:"+e)}function $(e,t,r){t&&(t=t.toString()),i.set("template_file:"+e,t,{expire:r.cache||a.cache})}function y(r,n,l){o=r.substr(r.lastIndexOf(".")),c=t.join(r,"..");let s=h(r);if(s){if(a&&"function"==typeof a.onBeforeRender){let e=a.onBeforeRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}else if(n&&"function"==typeof n.onBeforeRender){let e=n.onBeforeRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}let e=b(s,n);if(a&&"function"==typeof a.onAfterRender){let t=a.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}else if(n&&"function"==typeof n.onAfterRender){let t=n.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}return l(null,e.toString())}e.readFile(r,(function(e,t){if(e)return l(e);if($(r,t,n),a&&"function"==typeof a.onBeforeRender){let e=a.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}else if(n&&"function"==typeof n.onBeforeRender){let e=n.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}let s=b(t,n);if(a&&"function"==typeof a.onAfterRender){let e=a.onAfterRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}else if(n&&"function"==typeof n.onAfterRender){let e=n.onAfterRender(Buffer.from(s,"utf8"));e&&"string"==typeof e&&(s=e)}return l(null,s.toString())}))}function b(r,n){if(r=r.toString(),a&&a.raw)return r;if(r.startsWith("\n")||(r="\n\r"+r),r.endsWith("\n")||(r+="\n\r"),r=A(r),n){let e={};q(n,(t,r)=>{"function"!=typeof t&&(["string","number","boolean","object"].includes(typeof t)||Array.isArray(t))&&(e[r]=t)}),n=e}else n={};n.opts&&"object"==typeof n.opts||(n.opts={}),n.$&&"object"==typeof n.$||(n.$={}),n.$functions&&"object"==typeof n.$functions||(n.$functions={}),n.$userVars&&"object"==typeof n.$userVars||(n.$userVars={}),n.$returns&&"object"==typeof n.$returns||(n.$returns={}),n.extractTags?Array.isArray(n.extractTags)||(n.extractTags=[n.extractTags]):n.extractTags=[],a.extractTags&&(Array.isArray(a.extractTags)||(a.extractTags=[a.extractTags]),n.extractTags=[...a.extractTags,...n.extractTags]),r=(r=function(e,t){if(t.extractTags&&t.extractTags.length&&Array.isArray(t.extractTags)){let r=t.extractTags.map(e=>O(e.toString())).join("|");t.extractTags.includes("style")&&!t.extractTags.includes("link")&&(r+="|link");let n=new RegExp("<("+r+")(\\s+?.*?|)>(.*?)<\\/(?:"+r+")(?:\\s+?.*?|)>","gs");if(l(n)){const r={};e=e.replace(n,(function(e,n,l,s){let i="<"+(n=n.trim())+" "+l.trim()+">"+s+"</"+n+">";return"link"===n&&t.extractTags.includes("style")&&l.match(/\s+?rel="stylesheet"/gs)?(r.style||(r.style=[]),r.style.push(i),""):"link"!==n||t.extractTags.includes("link")&&!l.match(/\s+?rel="stylesheet"/gs)?(r[n]||(r[n]=[]),r[n].push(i),""):i})),n=new RegExp("{{-("+n+")}}","gs"),l(n)&&(e=e.replace(n,(function(e,t){return r[t]?r[t].join("\n"):""})))}}return e}(r=function(e,t){return e.replace(/({{{?)(.*?)(}}}?)/gs,(function(e,r,n,l){if(!n||""===n.trim())return"";const s="{{{"!==r||"}}}"!==l;if((n=n.toString().trim()).startsWith("-"))return n=n.substring(1).trim(),t.extractTags.push(n),"{{-"+n+"}}";if(n.includes("=")){if(!(n=n.split("=",2))[1]||""===n[1].trim())return"";n[1]=n[1].trim(),n[1].startsWith('"')&&n[1].endsWith('"')&&(n[1]=n[1].substring(1,n[1].length-1)),n[0]&&""!==n[0].trim()?n[0]=n[0].trim():n[0]=n[1],n[0].includes(".")&&(n[0]=n[0].split(".",1)[0]),n[0].includes("[")&&(n[0]=n[0].split("[",1)[0]);let e=j(n[1],t,"regve");return s&&(e=T(e)),n[0]+'="'+e+'"'}{n.startsWith('"')&&n.endsWith('"')&&(n=n.substring(1,n[1].length-1));let e=j(n,t,"regve");return s&&(e=T(e)),e}}))}(r=(r=(r=_(r=function(r,n){if(n.template||a.template){let l=n.template||a.template;if(l.endsWith(o)||(l+=o),l=l.startsWith(c)?t.resolve(l):t.join(c,l),!l.startsWith(c))return r;let s=h(l);if(!s&&e.existsSync(l)){if(s=e.readFileSync(l).toString(),!s||""===s.trim())return $(l,!1,n),r;$(l,s,n)}if(!s||""===s.trim())return r;s.startsWith("\n")||(s="\n\r"+s),s.endsWith("\n")||(s+="\n\r"),s=A(s),r=s.replace(/(<\?(js|php|)\s*?body\(\);?\s*?\?>|{{{?#?\s*?body\s*?}}}?)/gs,r)}return r}(r,n),n)).replace(/<\?(js|php|).*?\?>/gs,"")).replace(/<&[\w_\-]*%.*?%&>/gs,""),n),n)).split(/({{{?#no[_-]html}}}?.*?{{{?\/no[_-]html}}}?)/gis);for(let e=0;e<r.length;e++)r[e].match(/({{{?#no[_-]html}}}?.*?{{{?\/no[_-]html}}}?)/gis)?r[e]=T(r[e].replace(/{{{?#no[_-]html}}}?(.*?){{{?\/no[_-]html}}}?/gis,"$1")):r[e]=d(r[e],n);if(r=r.join(""),!a.noMarkdown&&!n.noMarkdown){r=r.split(/({{{?#no[_-]markdown}}}?.*?{{{?\/no[_-]markdown}}}?)/gis);for(let e=0;e<r.length;e++)r[e].match(/({{{?#no[_-]markdown}}}?.*?{{{?\/no[_-]markdown}}}?)/gis)?r[e]=r[e].replace(/{{{?#no[_-]markdown}}}?(.*?){{{?\/no[_-]markdown}}}?/gis,"$1"):r[e]=w(r[e],n);r=r.join("")}return(r=(r=(r=r.replace(/<\?(js|php|).*?\?>/gs,"").replace(/\?>/gs,"")).replace(/<&[\w_\-]*%.*?%&>/gs,"")).replace(/{{{?.*?}}}?/gs,"")).toString().trim()}function d(e,t){return e=e.replace(/\$\{(.*?)\}/gm,(function(e,r){return r=r.trim(),t.$userVars[r]?t.$userVars[r]:""})),t.noHtmlRules&&t.noHtmlRules.allowUserVars&&(e=e.replace(/\$&lbrace;(.*?)&rbrace;/gm,(function(e,r){return r=r.trim(),t.$userVars[r]?t.$userVars[r]:""}))),e}function _(e,t){return e.replace(/<\?(js|php|)(.*?)\?>/gs,(function(e,r,n){let s="";function i(e){return["string","number","boolean"].includes(typeof e)?e.toString():""}n=n.replace(/\/\*.*?\*\//gs,"").replace(/\/\/.*/gm,"");const a={...g};a.result=function(e){s+=i(e)},a.setResult=i,n=n.replace(/[\n\r\t\s]/gs," ").replace(/\s\s/gs," ").replace(/else\s*?{/gs,"else if(true){");const c={};let o=1e3;for(;n.match(/\{([^{}]*)\}/gs)&&o-- >0;)n=n.replace(/\{([^{}]*)\}/gs,(function(e,t){let r=m(16)+m(16);return c[r]=t,"<&%"+r+"%&>"}));n=(n=(n=n.replace(/<&%(.*?)%&>/gs,(function(e,t){return"{<&%"+t+"%&>}"}))).replace(/function\s*?([\w_\-.\[\]]+)\((.*?)\)\s*?\{<&%(.*?)%&>\}/gs,(function(e,r,n,l){l=c[l]?c[l]:"",n=n.split(",").map(e=>e.trim()).filter(e=>e&&""!==e);let s=1e3;for(;l.match(/<&%(.*?)%&>/gs)&&s-- >0;)l=l.replace(/<&%(.*?)%&>/gs,(function(e,t){return c[t]?"{"+c[t]+"}":"{}"}));return t.$functions[r]=function(e,t){const r=l,s=n,i={};for(let r=0;r<t.length;r++){let n=s[r]||r;i[n]=j(t[r],e)}let a=_("<? "+r.replace(/\$([\w_\-.\[\]]+)/gs,(function(t,r){return r="$"+r.toString().trim(),i[r]?j(i[r],e):t}))+" ?>",e),c=!1;return a=a.replace(/<&return%(.*?)%&>.*?/gs,(function(t,r){return c||(c=e.$returns[r]),""})),{result:a,return:c}},""}))).split(/(.*?[;}])/gs).filter(e=>e&&""!==e.trim()).map(e=>{e=e.replace(/\{<&%(.*?)%&>\}/gs,(function(e,t){return t&&""!==t.trim()&&c[t]?"{"+c[t]+"}":"{}"}));let t=0;for(;e.match(/<&%(.*?)%&>/gs)&&t-- >0;)e=e.replace(/<&%(.*?)%&>/gs,(function(e,t){return t&&""!==t.trim()&&c[t]?"{"+c[t]+"}":"{}"}));return e});const u={runElse:!1};for(let e=0;e<n.length;e++)if(n[e]=n[e].trim(),n[e].startsWith("echo_html "))s+=_(i(j(n[e].replace(/^echo_html\s*/,""),t,!0)),t);else if(n[e].startsWith("echo "))s+=T(i(j(n[e].replace(/^echo\s*/,""),t,!0)));else if(n[e].match(/^\$[\w_\-.\[\]]+\s*?[+\-*\/.]?=\s*?.*?/))n[e].replace(/^\$([\w_\-.\[\]]+)\s*?([+\-*\/.]|)=\s*?(.*?)[;}]/,(function(e,r,n,s){if(s=j(s,t,!1,{funcOpts:u,funcMethods:a}),!n||""===n.trim())return void(t.$[r]=s);let i=t.$[r];if("string"==typeof i&&i.match(/^-?[0-9]+(\.[0-9]+|)$/)&&Number(i)&&(i=Number(i)),Array.isArray(i))"+"===n||"."===n||"*"===n?t.$[r].push(s):"-"!==n&&"/"!==n||i.indexOf(s)&&t.$[r].splice(i.indexOf(s),1);else if("object"!=typeof i||"object"!=typeof s)if("object"!=typeof i||"string"!=typeof s&&!Array.isArray(s)||"-"!==n&&"/"!==n){if(["string","boolean","number"].includes(typeof s)&&["string","boolean","number"].includes(typeof i))if("+"===n||"."===n)t.$[r]=i+s;else if("-"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i-s;else if("-"===n)t.$[r]=i.replace(s,"");else if("*"===n&&"number"==typeof s&&"string"==typeof i)t.$[r]=i.repeat(s);else if("*"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i*s;else if("*"===n)t.$[r]=i+s;else if("/"===n&&"number"==typeof s&&"number"==typeof i)t.$[r]=i/s;else if("/"===n){let e=new RegExp(O(s),"g");l(e)&&(t.$[r]=i.replace(e,""))}}else{let e=Object.keys(i),t=Object.values(i);Array.isArray(s)||(s=[s]);for(let r=0;r<s.length;r++)delete i[e[t.indexOf(s[r])]]}else if("+"===n||"."===n||"*"===n){let e=Object.keys(s);for(let t=0;t<e.length;t++)i[e[t]]=s[e[t]];t.$[r]=i}else if("-"===n||"/"===n){let e=Object.keys(i),t=Object.values(i),r=Object.values(s);for(let n=0;n<r.length;n++)delete i[e[t.indexOf(r[n])]]}}));else if(n[e].match(/^(else |)[\w_\-.\[\]]+\(.*?\)(\{.*?\}|)/)){let r=S(n[e],t,u.runElse,a);u.runElse=r.runElse,r.result&&(s+=r.result.toString()),r.return&&["string","number","boolean"].includes(typeof r.return)&&(s+=r.return.toString())}return s}))}function S(e,t,r=!1,n){let l="",s=!1;return e.replace(/^(else |)([\w_\-.\[\]]+)\((.*?)\)(?:\{(.*?)\}|)/,(function(e,i,a,c,o){if(r||!i||""===i.trim())if(r=!1,c=c?c.toString():"",t.$functions[a]){c=c.split(",").map(e=>e.trim()).filter(e=>e&&""!==e);let e=t.$functions[a](t,c);e.result&&(l+=e.result.toString()),e.return&&(s=e.return)}else if(p[a]){c=c.split(",").map(e=>e.trim()).filter(e=>e&&""!==e);let e={};if(p[a].attrs){let t=p[a].attrs;for(let r=0;r<t.length;r++)e[t[r]]=c.shift()}for(let t=0;t<c.length;t++)e[t]||(e[t]=c[t]);n.setObject=function(e,r){return j(e,t,r)};let l=void 0;p[a].hasContent&&o&&""!==o.toString().trim()?l=p[a].callback(t,e,o.toString(),n):p[a]&&(l=p[a].callback(t,e,null,n)),!1===l?(r=!0,s=!1):s=l}})),{result:l,return:s,runElse:r}}function j(e,t,r=!1,n=!1){if(!e||!["string","number","boolean"].includes(typeof e))return;(e=e.toString().trim()).endsWith(";")&&(e=e.substring(0,e.length-1));let s=!1;if("regve"===r&&(s=!0),!s&&n&&"string"==typeof e&&e.match(/([\w_\-$]+)\((.*?)\)/),e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]"))try{let t=JSON.parse(M(e));return r?JSON.stringify(t):t}catch(e){}const i={};e=(e=e.replace(/(['"])(.*?)\1/gs,(function(e,t,r){let n=m(16)+m(16);return i[n]=r,t+"<&%"+n+"%&>"+t}))).split(/((?:[0-9+\-*/^().e!]|pi|sin|cos|tan|asin|acos|atan|root|pow)+)/gs);for(let t=0;t<e.length;t++)e[t]&&""!==e[t].trim()&&!e[t].match(/^[\w0-9.]+$/s)&&e[t].match(/^([0-9+\-*/^().e!]|pi|sin|cos|tan|asin|acos|atan|root|pow)+$/s)&&(e[t]=e[t].split(/^([+\-*/.]*)(.*?)([+\-*/.]*)$/s),e[t][2]&&(e[t][2]=W(e[t][2])),e[t]=e[t].join(""));(e=e.join("").split(/([+\-*\/]|\.(?=[^\w_0-9])|[^\w_0-9]\.(?=[0-9]))/g)).length>1&&(r=!0);let a="",c=".";function o(e){if("undefined"==typeof e)return"";if("."===c||"+"===c)a+=e.toString();else if("-"===c)a=a.replace(e.toString(),"");else if("*"!==c||"number"!=typeof e&&!e.toString().match(/^[0-9]+(\.[0-9]+|)$/)){if("*"===c)a+=e.toString();else if("/"===c){let t=new RegExp(O(e.toString()),"g");l(t)&&(a=a.replace(t,""))}}else a=a.repeat(Number(e))}for(let t=0;t<e.length;t++)e[t].match(/^(['"])\s*?\.\s*?\1?.?$/)&&(e[t]="."),[".","+","-","*","/"].includes(e[t].trim())?c=e[t].trim():e[t].trim().match(/^[0-9]+(\.[0-9]+|)$/s)?o(e[t].trim()):(e[t].trim().match(/^(['"])<&%(.*)%&>(\1|)$/)&&(e[t]=e[t].trim().replace(/^(['"])<&%(.*)%&>(\1|)$/,(function(e,t,r){return i[r]?t+i[r]+t:t+t}))),e[t].match(/^(['"]).*\1.?$/)?o(e[t].trim().replace(/^(['"])(.*)\1.?$/,"$2")):e[t].match(/^(['"]).*.?$/)?(e[t+1]&&e[t+1].match(/^(['"])\s*?\.\s*?.?$/)&&(e[t+1].startsWith("'")?e[t]+="'":e[t+1].startsWith('"')&&(e[t]+='"')),o(e[t].trim().replace(/^(['"])(.*)\1.?$/,"$2"))):o(u(e[t].trim())));function u(e){e=e.split("|");let t=void 0;for(let r=0;r<e.length&&(t=p(e[r]),!t);r++);return s&&void 0===t&&(t=""),t}function p(e){let n;return"true"===e||"false"!==e&&(n=s&&e.startsWith("$")?B(e.replace("$",""),t.$):s?B(e,t.opts):e.startsWith("$Opts.")||e.startsWith("$Options.")||e.startsWith("$_OPTIONS.")||e.startsWith("$_OPTS.")?B(e.replace(/^\$_?opt(?:ion)?s(\.|\[(.*?|)\])/i,f),t.opts):e.startsWith("$Post.")||e.startsWith("$_POST.")?B("req.body."+e.replace(/^\$_?post(\.|\[(.*?|)\])/i,f),t):e.startsWith("$Get.")||e.startsWith("$_GET.")?B("req.query."+e.replace(/^\$_?get(\.|\[(.*?|)\])/i,f),t):e.startsWith("$Data.")||e.startsWith("$_DATA.")?B("req.data."+e.replace(/^\$_?data(\.|\[(.*?|)\])/i,f),t):e.startsWith("$")?B(e.replace("$",""),t.$):B(e,t.$),r&&(n=!n&&0!==n||!["string","number","boolean"].includes(typeof n)?void 0:n.toString()),n)}function f(e,t){return t?t.replace(/\s/g,"").replace(/^\.*/,""):""}return r?(["string","number","boolean"].includes(typeof a)||(a=""),a.toString()):("string"==typeof a&&a.match(/^-?[0-9]+(\.[0-9]+|)$/)?a=Number(a):"true"===a?a=!0:"false"===a&&(a=!1),a)}function W(e){e=e.toString();try{e=s.eval(e)}catch(t){e="NaN"}return e}function w(e,t){if(!e&&0!==e&&!1!==e)return null;e=e.toString();let r={};return"object"==typeof a.noHtmlRules&&"object"==typeof t.noHtmlRules?r={...a.noHtmlRules,...t}:"object"==typeof a.noHtmlRules?r={...a.noHtmlRules}:"object"==typeof t.noHtmlRules&&(r={...t.noHtmlRules}),e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/(?:\*|&ast;){3}([^*]+)(?:\*|&ast;){3}/g,"<strong><em>$1</em></strong>")).replace(/(?:\*|&ast;){2}([^*]+)(?:\*|&ast;){2}/g,"<strong>$1</strong>")).replace(/(?:\*|&ast;)([^*]+)(?:\*|&ast;)/g,"<em>$1</em>")).replace(/__([^_]+)__/g,"<u>$1</u>")).replace(/~~([^~]+)~~/gs,"<s>$1</s>")).replace(/(?:#){6}\s*(.+)/g,"<h6>$1</h6>")).replace(/(?:#){5}\s*(.+)/g,"<h5>$1</h5>")).replace(/(?:#){4}\s*(.+)/g,"<h4>$1</h4>")).replace(/(?:#){3}\s*(.+)/g,"<h3>$1</h3>")).replace(/(?:#){2}\s*(.+)/g,"<h2>$1</h2>")).replace(/(?:#)\s*(.+)/g,"<h1>$1</h1>"),r.allowHeaders&&(e=(e=(e=(e=(e=(e=e.replace(/(?:&num;){6}\s*(.+)/g,"<h6>$1</h6>")).replace(/(?:&num;){5}\s*(.+)/g,"<h5>$1</h5>")).replace(/(?:&num;){4}\s*(.+)/g,"<h4>$1</h4>")).replace(/(?:&num;){3}\s*(.+)/g,"<h3>$1</h3>")).replace(/(?:&num;){2}\s*(.+)/g,"<h2>$1</h2>")).replace(/(?:&num;)\s*(.+)/g,"<h1>$1</h1>")),e=(e=(e=(e=(e=(e=e.replace(/[\n\r]-{3,}[\n\r]/g,"<hr>")).replace(/(?:`|&grave;){3}(.+?)(?:`|&grave;){3}/gs,"<pre>$1</pre>")).replace(/(?:`|&grave;)(.+?)(?:`|&grave;)/gs,"<p>$1</p>")).replace(/([^"'])((?!["'])https?:\/\/(?:(?:[\w_-][\w_\-.]+)|)(?:(?:[\w.,@?^=%&:/~+#_-]*[\w.,@?^=%&:/~+#_-])|))/g,'$1<a href="$2">$2</a>')).replace(/\!\[(.*?)\]\((.*?)\)/g,'<img src="$2" alt="$1">')).replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),r.allowImages&&(e=e.replace(/\!&lbrack;(.*?)&rbrack;&lpar;(.*?)&rpar;/g,'<img src="$2" alt="$1">')),r.allowCustomLinks&&(e=e.replace(/&lbrack;(.*?)&rbrack;&lpar;(.*?)&rpar;/g,'<a href="$2">$1</a>')),(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\[ss\]/g,"§")).replace(/\[$c\]/g,"¢")).replace(/\[$e\]/g,"€")).replace(/\[$p\]/g,"£")).replace(/\[c\]/g,"©")).replace(/\[r\]/g,"®")).replace(/\[tm\]/g,"™")).replace(/\[p\]/g,"¶")).replace(/\[Dc\]/g,"℃")).replace(/\[Df\]/g,"℉")).replace(/\[D\]/g,"°")).replace(/\[M\+\]/g,"+")).replace(/\[M-\]/g,"−")).replace(/\[Mx\]/g,"×")).replace(/\[M\/\]/g,"÷")).replace(/\[M=\]/g,"=")).replace(/\[M\!=\]/g,"≠")).replace(/\[M\+-\]/g,"±")).replace(/\[M<\]/g,"<")).replace(/\[M>\]/g,">")).replace(/\[M<=\]/g,"⋜")).replace(/\[M>=\]/g,"⋝")).replace(/\[M%\]/g,"%")).replace(/\[M%0\]/g,"‰")).replace(/\[M%00\]/g,"‱")).replace(/\[Msum\]/g,"∑")).replace(/\[M(sqrt|2root|root)\]/g,"√")).replace(/\[M(cbrt|3root)\]/g,"∛")).replace(/\[M4root\]/g,"∜")).replace(/\[M00\]/g,"∞")).replace(/\[MA(r|90)\]/g,"∟")).replace(/\[MA(a|45|)\]/g,"∠")).replace(/\[M=\?\]/g,"≈")}function A(e){if(!e&&0!==e&&!1!==e)return null;if(e=v(e+="?>"),!u||u.length<1)return e.toString();const t=u.join("|");let r=[],n=new RegExp("(</?(?![^A-Za-z0-9_-]|!DOCTYPE|"+t+")(?:(?:\\s+?[^>]*?)|)>)","gsi");if(!l(n))return e.toString();for(e=e.split(n).map(e=>{if(e.match(n)){let t=e.replace(/<\/?([A-Za-z0-9_-]+).*?>/gis,"$1");if(e.startsWith("</")){if(r.length<=0)return"";if(r[r.length-1]===t)return r.pop(),"</"+t+">";{let e="";for(;r.length>0&&r[r.length-1]!==t;)e+="</"+r[r.length-1]+">",r.pop();return e}}r.push(t)}return e});r.length>0;)e.push("</"+r[r.length-1]+">"),r.pop();return(e=e.join("")).toString()}function x(e){return e&&"string"==typeof e&&""!==e.trim()?(u.includes(e)||u.push(e),!0):null}function v(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"&lt;$1$2$3"):null}function k(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"$2$3"):null}function T(e){return e||0===e||!1===e?e.toString().replace(/&(?!(amp|gt|lt|lbrace|rbrace|sol|bsol|quest|equals|lbrack|rbrack|lpar|rpar|vert|num|sect|ast|comma|period|grave|apos|quot);)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/{/g,"&lbrace;").replace(/}/g,"&rbrace;").replace(/\//g,"&sol;").replace(/\\/g,"&bsol;").replace(/\?/g,"&quest;").replace(/=/g,"&equals;").replace(/\[/g,"&lbrack;").replace(/\]/g,"&rbrack;").replace(/\(/g,"&lpar;").replace(/\)/g,"&rpar;").replace(/\|/g,"&vert;").replace(/#/g,"&num;").replace(/§/g,"&sect;").replace(/\*/g,"&ast;").replace(/,/g,"&comma;").replace(/\./g,"&period;").replace(/`/g,"&grave;").replace(/'/g,"&apos;").replace(/"/g,"&quot;"):null}function R(e){return e||0===e||!1===e?e.toString().replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&lbrace;/g,"{").replace(/&rbrace;/g,"}").replace(/&sol;/g,"/").replace(/&bsol;/g,"\\").replace(/&quest;/g,"?").replace(/&equals;/g,"=").replace(/&lbrack;/g,"[").replace(/&rbrack;/g,"]").replace(/&lpar;/g,"(").replace(/&rpar;/g,")").replace(/&vert;/g,"|").replace(/&num;/g,"#").replace(/&sect;/g,"§").replace(/&ast;/g,"*").replace(/&comma;/g,",").replace(/&period;/g,".").replace(/&grave;/g,"`").replace(/&apos;/g,"'").replace(/&quot;/g,'"'):null}function O(e){return e.replace(/([.*+?^${}()|[\]\\])/g,"\\$1")}function M(e){return e.replace(/[\s\n\r\t]/gs,"").replace(/,([}\]])/gs,"$1").replace(/([,{\[]|)(?:("|'|)([\w_\- ]+)\2:|)("|'|)(.*?)\4([,}\]])/gs,(e,t,r,n,l,s,i)=>(s=s.replace(/"/gis,"").trim(),n&&(n='"'+n.replace(/"/gis,"").trim()+'"'),s.match(/^[0-9]+(\.[0-9]+|)$/)||["true","false"].includes(s)||(s='"'+s+'"'),n?t+n+":"+s+i:t+s+i))}function q(e,t){if(e&&["string","number"].includes(typeof e)&&(e=[e]),e&&"object"==typeof e){let r=Object.keys(e);for(let n=0;n<r.length;n++)t(e[r[n]],r[n],e)}else if(e&&Array.isArray(e))for(let r=0;r<e.length;r++)t(e[r],r,e)}function B(e,t){return!t||!e||"object"!=typeof t&&!Array.isArray(t)||"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e?null:(e=e.split(/(?:\.|\[([^\]]+)\])/gs).filter(e=>e&&""!==e.trim())).reduce((function(e,t){if(t&&"object"==typeof e&&"undefined"!=typeof e[t])return e[t]}),t)}module.exports=function(){let e=function(e){return"object"==typeof e&&(Object.assign(a,e),(e.cacheDev||!1===e.cacheDev)&&n.cacheDevelopment(e.cacheDev)),y};return e.render=b,e.addFunction=f,e.defineSingleTagType=x,e.customMarkdown=w,e.escapeHtml=T,e.unescapeHtml=R,e.escapeInvalidTags=v,e.stripInvalidTags=k,e.escapeRegex=O,e.normalizeJson=M,e.forEach=q,e.getObj=B,e.autoCloseTags=A,e}();